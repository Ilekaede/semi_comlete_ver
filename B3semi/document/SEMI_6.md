# B4 プログラミングゼミ 第 6 回

## 今回の課題

- Hough 変換(直線検出)

実装の際は以下のようなことを考えてみてください。(ひょっとしたら考察のネタになるかも...)

- Hough 変換の原理はどのようなものか
- 直線が検出されやすくするためにはどうすればいいか
- 直線の決定式は最適であるか、問題点はあるのか

## Hough 変換

**Hough 変換** は、画像中の特定の形状やパターンを検出および識別するために使用される画像処理技術の 1 つです。主に直線や円などの幾何学的な形状を検出するために使用します。

<div style="text-align: center;">
<img src="semi_img/6_example.png" width = "400">

図 1 Hough 変換

</div>

### Hough 変換の原理

$xy$画像空間中の直線は、 $a$を傾き、 $b$を切片とした時、(1)式で表すことができます。

$y = ax + b \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \  - (1)$

傾きと $y$ 切片との 2 つのパラメータで直線を表現できるため、これらのパラメータを座標軸にした空間( $ab$ パラメータ空間 )では、 $xy$ 画像空間中のある直線を 1 点で表すことができます(図 2)。

<div style="text-align: center;">
<img src="semi_img/6_xy.png" width = "400">

図 2 $xy$ 画像空間と $ab$ パラメータ空間の関係

</div>

一方で、 $xy$ 画像空間中の直線を $l$ としたとき、直線 $l$ 上の点( $x_i$ , $y_i$ )は、(2)式で $ab$ パラメータ空間に写像されます。

$b = -x_i a + y_i \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \  - (2)$

$xy$ 画像空間中の点は、 $ab$ パラメータ空間では傾き $-x_i$ と $b$ 切片 $y_i$ の直線で表すことができるため、直線 $l$ 上の複数の点を $ab$ パラメータ空間に写像すると、点の数だけ直線を描くことができます。これらの直線は $ab$ パラメータ空間内の 1 点 $(a, b)$ で交差します。

つまり、この交差する点の座標を検出すれば、 $xy$ 画像空間中の直線を決定することができるのです。

<div style="text-align: center;">
<img src="semi_img/6_ab2xy.png">

図 3 $ab$空間上の点と $xy$ 画像空間中の直線

</div>

### 実際に使用する式について

直線式(1)は、パラメータ $a, b$ の取り得る値域が $- \infty \sim + \infty$ となることが考えられます。そのため、パラメータ空間の大きさを制限するために、実際には三角関数を用いた(3)の式を使うのが一般的です。

$\rho = x cos \theta + y sin \theta \ \ \ \ \ \ \ - (3)$

このとき、 $\rho$ は原点から直線までの符号付き距離、 $\theta$ は原点から直線への垂角 $(0 \leqq \theta < \pi)$ を表しています (図 4 を参照)。

<div style="text-align: center;">
<img src="semi_img/6_line.png" width = "400">

図 4 点と $ρ,θ$ の関係

</div>

$xy$画像平面中の点 $(x_i, y_i)$ を通る可能性のある直線を検出するため、 $ρ-θ$ 空間では投票処理が行なわれます。 $xy$ 空間全体の画素それぞれについて投票処理の対象としていくと、直線が存在する可能性の高いパラメータ $(ρ,θ)$ には投票がより多く集まっていきます。集まった票がしきい値を超えた点について、パラメータ $(\rho, \theta)$ を(3)式に代入することで、 $xy$ 画像空間中の直線を導出することができます。

例として、図 5 左の状態から点 $A$ 、点 $B$ 、点 $C$ が直線 $l$ 上にあることを検出してみます。それぞれの点を式(3)に代入し、 $\theta$ のパラメータを動かすことで、図 5 真ん中のように、 $\rho \theta$ パラメータ空間には正弦波が写像されます。これら正弦波上すべての点に対して投票処理を行なうと、正弦波が重なりあう点については複数の票が集まることになります。その点の座標こそが、点 $A$ 、点 $B$ 、点 $C$ を線上に持つような直線 $l$ のパラメータとなります。

<div style="text-align: center;">
<img src="semi_img/6_graph.png">

図 5 投票と検出のイメージ

</div>

実際に画像に Hough 変換を適用した例を図 6 に示します。

<div style="text-align: center;">
<img src="semi_img/6_detected.png" width = "400">

図 6 Hough 変換処理の実装前と実装後

</div>

## 実装課題

1. 配布されたコードをそのまま実装すると，図 7 のように 1 本の直線に対して検出を示す赤い線が何本も出力されていしまいます．

そこで，Hough 空間に対するフィルタリング処理(is_max_value_in_filter())を実装し，現在注目する $ \rho, \theta $ がカーネル内の極大値であるか判定してください．

2. 現在のコードでは直線の描画処理を一次関数の一般式 $y = ax + b$ の形を用いて実装しています．しかし，この式は $a$ の値が極端に大きくなった際の描画に向いていないという問題点があります．そこで，直線の描画を媒介変数を用いた式に書き換えてください．

## 今後の予定

- **今回** ー Hough 変換の説明．次回までに課題を実装する

  - この時点では精度上げはまだしなくていい(先にやりたい人はやっても OK)

- **次回** ー 課題が完成しなかった人の補助 + 補足説明(精度上げのヒント) + 質問

- **最終回** ー レジュメとスライドを作成し、佐治先生、M2、M1、B4 の前で発表
